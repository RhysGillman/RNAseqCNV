#!/usr/bin/perl
use strict;
use warnings;
use Getopt::Std;

my %opts = (n => 3, h => 0.01 );
getopts( 'i:o:n:h:', \%opts );
print(
	qq/qulity control of vcf files
Options: 
	-i STRING	raw vcf from GATK UnifiedGenotype [required]
	-o STRING	output file [required]
	-n INT		minimum number of reads support the var [$opts{n}]
	-h DOUBLE	minimum heterozygous rate of supportive reads [$opts{h}]
\n/
);

die("Input vcf and output file names are needed!\n")
  if ( !$opts{i} || !$opts{o} );
my ( $fin, $fout, $ad2TH, $hetTH ) =
  ( $opts{i}, $opts{o}, $opts{n}, $opts{h} );
print "Parameters are:\n\t -i $fin -o $fout -n $ad2TH -h $hetTH!\n";

open( IN,  "$fin" )   || die("Could not open file $fin!\n");
open( OUT, ">$fout" ) || die("Could not create file $fout!\n");
my $title = join( "\t",
	qw(chrom. start refAllele varAllele end quality depth refDepth varDepth mapQual MAF)
);
print OUT '#' . $title, "\n";

while ( my $line = <IN> ) {
	next if ( $line =~ /^#/ );
	chomp $line;
	my ( $chr, $start, $ref, $alt, $qual, $dp, $ad1, $ad2, $mq, $het)
	  =	  annoExtract($line);
	next unless ($het);
	next if (length($ref) > 1 or length($alt) > 1);
	next if ( length($chr) > 5 or $ad2 < $ad2TH or $het < $hetTH );
	my $end = $start + length($ref) - 1;
	print OUT join( "\t",
		( $chr, $start, $ref, $alt, $end, $qual, $dp, $ad1, $ad2, $mq, $het) ),
	  "\n";
}
close IN;
close OUT;

sub annoExtract {
	my ($line) = @_;
	my (
		$chr,    $start, $ID,     $ref,
		$alt,    $qual,  $FILTER, $info,
		$FORMAT, @alleleInfoArray
	) = split( /\t/, $line );
	($alt) = split( ',', $alt );
	my ($dp) = $info =~ /DP=(\d+)/;
	return 0 unless $dp;
	my ($mq) = $info =~ /MQ=(.+?);/;
	my @formats = split( ':', $FORMAT );
	my ($adIdx) = grep { $formats[$_] eq "AD" } 0 .. $#formats;
	my ( $ad1, $ad2 ) = ( 0, 0 );

	for my $alleleInfo (@alleleInfoArray) {
		next unless ( $alleleInfo =~ /:/ );
		my @alleles = split( ':', $alleleInfo );
		my ( $ad1_i, $ad2_i ) = split( ',', $alleles[$adIdx] );
		if ( $ad1_i =~ /\d+/ && $ad2_i =~ /\d+/ ) {
			$ad1 = $ad1 + $ad1_i;
			$ad2 = $ad2 + $ad2_i;
		}
	}
	my $het = sprintf( "%0.4f", $ad2 / $dp ) if ($ad2);
	return ( $chr, $start, $ref, $alt, $qual, $dp, $ad1, $ad2, $mq, $het);
}

